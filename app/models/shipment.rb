class Shipment
  
  # Open and read jpegger image preview page, over ssl
  def self.preview(capture_sequence_number, company_id)
    company = Company.find(company_id)
    require "open-uri"
    url = "https://#{company.jpegger_service_ip}:#{company.jpegger_service_port}/sdcgi?preview=y&table=shipments&capture_seq_nbr=#{capture_sequence_number}&yardid=#{company.yard_id}"
    return open(url, :ssl_verify_mode => OpenSSL::SSL::VERIFY_NONE).read
  end
  
  def self.preview_source(capture_sequence_number, company_id)
    company = Company.find(company_id)
    require "open-uri"
    url = "https://#{company.jpegger_service_ip}:#{company.jpegger_service_port}/sdcgi?preview=y&table=shipments&capture_seq_nbr=#{capture_sequence_number}&yardid=#{company.yard_id}"
    image =  open(url, :ssl_verify_mode => OpenSSL::SSL::VERIFY_NONE).read
    unless image.blank?
      "data:image/jpg;base64, #{Base64.strict_encode64(image)}"
    else
      "data:image/jpeg;base64,/9j/4QlQaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzEzOCA3OS4xNTk4MjQsIDIwMTYvMDkvMTQtMDE6MDk6MDEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/+0ALFBob3Rvc2hvcCAzLjAAOEJJTQQlAAAAAAAQ1B2M2Y8AsgTpgAmY7PhCfv/bAIQAAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQICAgICAgICAgICAwMDAwMDAwMDAwEBAQEBAQECAQECAgIBAgIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD/90ABABk/+4ADkFkb2JlAGTAAAAAAf/AABEIAlgDIAMAEQABEQECEQH/xAB/AAEBAQEBAQEBAQAAAAAAAAAACgsIBgkEBwUBAQAAAAAAAAAAAAAAAAAAAAAQAQAABQMABQkHAgQGAwEAAAACAwQFBgEHCBEaOFjWCRITV3d4krfXChQYIZSVlxa2FSIxQRcjJGGRoSUmMlERAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwAAARECEQA/AKGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ChgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//RoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//0qGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9OhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//UoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1aGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ahgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//XoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//0KGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9GhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//SoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//06GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ShgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//VoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1qGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ehgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//QoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//0aGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9KhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//ToYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1KGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9WhgAAAAAAAAAAA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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9GhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//SoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//06GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ShgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//VoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1qGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ehgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//QoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//0aGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9KhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//ToYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1KGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9WhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//WoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//16GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ChgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//RoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//2Q=="
    end
  end
  
  # Open and read jpegger image jpeg_image page, over ssl
  def self.jpeg_image(capture_sequence_number, company_id)
    company = Company.find(company_id)
    require "open-uri"
    url = "https://#{company.jpegger_service_ip}:#{company.jpegger_service_port}/sdcgi?image=y&table=shipments&capture_seq_nbr=#{capture_sequence_number}&yardid=#{company.yard_id}"
    return open(url, :ssl_verify_mode => OpenSSL::SSL::VERIFY_NONE).read
  end
  
  def self.jpeg_image_source(capture_sequence_number, company_id)
    company = Company.find(company_id)
    require "open-uri"
    url = "https://#{company.jpegger_service_ip}:#{company.jpegger_service_port}/sdcgi?image=y&table=shipments&capture_seq_nbr=#{capture_sequence_number}&yardid=#{company.yard_id}"
    image = open(url, :ssl_verify_mode => OpenSSL::SSL::VERIFY_NONE).read
    unless image.blank?
      "data:image/jpg;base64, #{Base64.strict_encode64(image)}"
    else
      "data:image/jpeg;base64,/9j/4QlQaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzEzOCA3OS4xNTk4MjQsIDIwMTYvMDkvMTQtMDE6MDk6MDEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/+0ALFBob3Rvc2hvcCAzLjAAOEJJTQQlAAAAAAAQ1B2M2Y8AsgTpgAmY7PhCfv/bAIQAAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQICAgICAgICAgICAwMDAwMDAwMDAwEBAQEBAQECAQECAgIBAgIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD/90ABABk/+4ADkFkb2JlAGTAAAAAAf/AABEIAlgDIAMAEQABEQECEQH/xAB/AAEBAQEBAQEBAQAAAAAAAAAACgsIBgkEBwUBAQAAAAAAAAAAAAAAAAAAAAAQAQAABQMABQkHAgQGAwEAAAACAwQFBgEHCBEaOFjWCRITV3d4krfXChQYIZSVlxa2FSIxQRcjJGGRoSUmMlERAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwAAARECEQA/AKGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ChgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//RoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//0qGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9OhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//UoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1aGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ahgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//XoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//0KGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9GhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//SoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//06GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ShgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//VoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1qGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ehgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//QoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//0aGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9KhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//ToYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1KGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9WhgAAAAAAAAAAA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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9GhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//SoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//06GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ShgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//VoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1qGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ehgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//QoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//0aGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9KhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//ToYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//1KGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9WhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//WoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//16GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/9ChgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//RoYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//2Q=="
    end
  end
  
  def self.find_by_capture_sequence_number(capture_sequence_number, user)
    company = user.company
    require 'socket'
    host = company.jpegger_service_ip
    port = company.jpegger_service_port
    
    # SQL command that gets sent to jpegger service
    command = "<FETCH><SQL>select * from shipments where capture_seq_nbr='#{capture_sequence_number}' AND yardid='#{company.yard_id}'</SQL><ROWS>100</ROWS></FETCH>"
    
    # SSL TCP socket communication with jpegger
    tcp_client = TCPSocket.new host, port
    ssl_client = OpenSSL::SSL::SSLSocket.new tcp_client
    ssl_client.connect
    ssl_client.sync_close = true
    ssl_client.puts command
    response = ssl_client.sysread(200000) # Read up to 200,000 bytes
    ssl_client.close
    
    data= Hash.from_xml(response.gsub(/&/, '/&amp;')) # Convert xml response to a hash, escaping ampersands first
    
    unless data["RESULT"]["ROW"].blank?
      return data["RESULT"]["ROW"] # SQL response comes back in <RESULT><ROW>
    else
      return nil # No image found
    end
  end
  
  def self.find_all_by_date_range(start_date, end_date, user)
    company = user.company
    require 'socket'
    host = company.jpegger_service_ip
    port = company.jpegger_service_port
    
    # SQL command that gets sent to jpegger service
#    command = "<FETCH><SQL>select * from shipments where SYS_DATE_TIME >= '#{start_date}' AND SYS_DATE_TIME <= '#{end_date}'</SQL><ROWS>1000</ROWS></FETCH>"
    command = "<FETCH><SQL>select * from shipments where SYS_DATE_TIME BETWEEN '#{start_date}' AND '#{end_date} 23:59:59.999' AND yardid='#{company.yard_id}'</SQL><ROWS>1000</ROWS></FETCH>"
    
    # SSL TCP socket communication with jpegger
    tcp_client = TCPSocket.new host, port
    ssl_client = OpenSSL::SSL::SSLSocket.new tcp_client
    ssl_client.connect
    ssl_client.sync_close = true
    ssl_client.puts command

    results = ""
    while response = ssl_client.sysread(1000) # Read 1000 bytes at a time
      results = results + response
      break if (response.include?("</RESULT>"))
    end
    
    ssl_client.close
    
    data= Hash.from_xml(results.gsub(/&/, '/&amp;')) # Convert xml response to a hash, escaping ampersands first
    
    unless data["RESULT"]["ROW"].blank?
      if data["RESULT"]["ROW"].is_a? Hash # Only one result returned, so put it into an array
        return [data["RESULT"]["ROW"]]
      else
        return data["RESULT"]["ROW"]
      end
    else
      return [] # No shipments found
    end
  end
  
  def self.external_user_find_all_by_date_range(start_date, end_date, user)
    company = user.company
    require 'socket'
    host = company.jpegger_service_ip
    port = company.jpegger_service_port
    
    # SQL command that gets sent to jpegger service
#    command = "<FETCH><SQL>select * from shipments where SYS_DATE_TIME >= '#{start_date}' AND SYS_DATE_TIME <= '#{end_date}'</SQL><ROWS>1000</ROWS></FETCH>"
    command = "<FETCH><SQL>select * from shipments where hidden IS NULL AND cust_name='#{user.customer_name}' AND SYS_DATE_TIME BETWEEN '#{start_date}' AND '#{end_date} 23:59:59.999' AND yardid='#{company.yard_id}'</SQL><ROWS>1000</ROWS></FETCH>"
    
    # SSL TCP socket communication with jpegger
    tcp_client = TCPSocket.new host, port
    ssl_client = OpenSSL::SSL::SSLSocket.new tcp_client
    ssl_client.connect
    ssl_client.sync_close = true
    ssl_client.puts command

    results = ""
    while response = ssl_client.sysread(1000) # Read 1000 bytes at a time
      results = results + response
      break if (response.include?("</RESULT>"))
    end
    
    ssl_client.close
    
    data= Hash.from_xml(results.gsub(/&/, '/&amp;')) # Convert xml response to a hash, escaping ampersands first
    
    unless data["RESULT"]["ROW"].blank?
      if data["RESULT"]["ROW"].is_a? Hash # Only one result returned, so put it into an array
        return [data["RESULT"]["ROW"]]
      else
        return data["RESULT"]["ROW"]
      end
    else
      return [] # No shipments found
    end
  end
  
  # Search jpegger shipments for this company
  def self.search(search_params, user)
    company = user.company
    require 'socket'
    host = company.jpegger_service_ip
    port = company.jpegger_service_port
    
    ticket_number = search_params[:ticket_number]
    customer_name = search_params[:customer_name]
    event_code = search_params[:event_code]
    start_date = search_params[:start_date]
    end_date = search_params[:end_date]
    
    date_search_string = (start_date.present? and end_date.present?) ? "AND SYS_DATE_TIME BETWEEN '#{start_date}' AND '#{end_date} 23:59:59.999'" : ""
    
    if ticket_number.present?
      if customer_name.present? and event_code.present?
        command = "<FETCH><SQL>select * from shipments where ticket_nbr='#{ticket_number}' AND cust_name LIKE '#{customer_name}' AND event_code LIKE '#{event_code}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
      elsif customer_name.present?
        command = "<FETCH><SQL>select * from shipments where ticket_nbr='#{ticket_number}' AND cust_name LIKE '#{customer_name}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
      elsif event_code.present?
        command = "<FETCH><SQL>select * from shipments where ticket_nbr='#{ticket_number}' AND event_code LIKE '#{event_code}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
      else
        command = "<FETCH><SQL>select * from shipments where ticket_nbr='#{ticket_number}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
      end
    elsif customer_name.present?
      if event_code.present?
        command = "<FETCH><SQL>select * from shipments where cust_name LIKE '#{customer_name}' AND event_code LIKE '#{event_code}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
      else
        command = "<FETCH><SQL>select * from shipments where cust_name LIKE '#{customer_name}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
      end
    elsif event_code.present?
      command = "<FETCH><SQL>select * from shipments where event_code LIKE '#{event_code}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
    elsif start_date.present? and end_date.present?
      command = "<FETCH><SQL>select * from shipments where SYS_DATE_TIME BETWEEN '#{start_date}' AND '#{end_date} 23:59:59.999' AND yardid='#{company.yard_id}'</SQL><ROWS>1000</ROWS></FETCH>"
    end

#    command = "<FETCH><SQL>select * from shipments_data where hidden != '1'</SQL><ROWS>1000</ROWS></FETCH>"

#    Rails.logger.debug "********************Shipment.search command: #{command}"
    
    # SSL TCP socket communication with jpegger
    tcp_client = TCPSocket.new host, port
    ssl_client = OpenSSL::SSL::SSLSocket.new tcp_client
    ssl_client.connect
    ssl_client.sync_close = true
    ssl_client.puts command

    results = ""
    while response = ssl_client.sysread(1000) # Read 1000 bytes at a time
      results = results + response
      break if (response.include?("</RESULT>"))
    end
    
    ssl_client.close
    
    data= Hash.from_xml(results.gsub(/&/, '/&amp;')) # Convert xml response to a hash, escaping ampersands first
    
    unless data["RESULT"]["ROW"].blank?
      if data["RESULT"]["ROW"].is_a? Hash # Only one result returned, so put it into an array
        return [data["RESULT"]["ROW"]]
      else
        return data["RESULT"]["ROW"]
      end
    else
      return [] # No shipments found
    end
  end
  
  # Search jpegger shipments for external user
  def self.external_user_search(search_params, user)
    company = user.company
    require 'socket'
    host = company.jpegger_service_ip
    port = company.jpegger_service_port
    
    ticket_number = search_params[:ticket_number]
    event_code = search_params[:event_code]
    start_date = search_params[:start_date]
    end_date = search_params[:end_date]
    
    date_search_string = (start_date.present? and end_date.present?) ? "AND SYS_DATE_TIME BETWEEN '#{start_date}' AND '#{end_date} 23:59:59.999'" : ''
    
    if ticket_number.present?
      if event_code.present?
        command = "<FETCH><SQL>select * from shipments where hidden IS NULL AND cust_name='#{user.customer_name}' AND ticket_nbr='#{ticket_number}' AND event_code LIKE '#{event_code}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
      else
        command = "<FETCH><SQL>select * from shipments where hidden IS NULL AND cust_name='#{user.customer_name}' AND ticket_nbr='#{ticket_number}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
      end
    elsif event_code.present?
      command = "<FETCH><SQL>select * from shipments where hidden IS NULL AND cust_name='#{user.customer_name}' AND event_code LIKE '#{event_code}' AND yardid='#{company.yard_id}' " + date_search_string + "</SQL><ROWS>1000</ROWS></FETCH>"
    elsif start_date.present? and end_date.present?
      command = "<FETCH><SQL>select * from shipments where hidden IS NULL AND cust_name='#{user.customer_name}' AND SYS_DATE_TIME BETWEEN '#{start_date}' AND '#{end_date} 23:59:59.999' AND yardid='#{company.yard_id}'</SQL><ROWS>1000</ROWS></FETCH>"
    else
      command = "<FETCH><SQL>select * from shipments where hidden IS NULL AND cust_name='#{user.customer_name}' AND yardid='#{company.yard_id}'</SQL><ROWS>1000</ROWS></FETCH>"
    end
    
    # SSL TCP socket communication with jpegger
    tcp_client = TCPSocket.new host, port
    ssl_client = OpenSSL::SSL::SSLSocket.new tcp_client
    ssl_client.connect
    ssl_client.sync_close = true
    ssl_client.puts command

    results = ""
    while response = ssl_client.sysread(1000) # Read 1000 bytes at a time
      results = results + response
      break if (response.include?("</RESULT>"))
    end
    
    ssl_client.close
    
    data= Hash.from_xml(results.gsub(/&/, '/&amp;')) # Convert xml response to a hash, escaping ampersands first
    
    unless data["RESULT"]["ROW"].blank?
      if data["RESULT"]["ROW"].is_a? Hash # Only one result returned, so put it into an array
        return [data["RESULT"]["ROW"]]
      else
        return data["RESULT"]["ROW"]
      end
    else
      return [] # No shipments found
    end
  end
  
  def self.latitude_and_longitude(company, capture_sequence_number)
    require "open-uri"
    url = "https://#{company.jpegger_service_ip}:#{company.jpegger_service_port}/sdcgi?image=y&table=shipments&capture_seq_nbr=#{capture_sequence_number}&yardid=#{company.yard_id}"
    
    begin
      data = Exif::Data.new(open(url, :ssl_verify_mode => OpenSSL::SSL::VERIFY_NONE))

      latitude = data.gps_latitude
      longitude = data.gps_longitude
      latitude_ref = data.gps_latitude_ref
      longitude_ref = data.gps_longitude_ref

      latitude_decimal = latitude.blank? ? nil : (latitude[0] + latitude[1]/60 + latitude[2]/3600).to_f.round(6)
      longitude_decimal = longitude.blank? ? nil : (longitude[0] + longitude[1]/60 + longitude[2]/3600).to_f.round(6)

      unless latitude_decimal.blank? or longitude_decimal.blank?
        return "#{latitude_decimal} #{latitude_ref},#{longitude_decimal} #{longitude_ref}"
      else
        return ""
      end
    rescue => e
      Rails.logger.info "Shipment.latitude_and_longitude: #{e}"
      return ""
    end
  end
  
  def Shipment.google_map(center)
    return "https://www.google.com/maps/embed/v1/place?key=#{ENV['GOOGLE_MAPS_API_KEY']}&q=#{center}&zoom=19"
  end
  
end